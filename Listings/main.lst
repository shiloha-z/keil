C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\KEIL\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main.ls
                    -t) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "reg52.h"
   2          #include <intrins.h>
   3          
   4          #define first_row 0x80
   5          #define secode_row 0x80 + 0x40
   6          #define uint unsigned int
   7          #define uchar unsigned char
   8          #define buzzer_open 1
   9          #define buzzer_close 0
  10          
  11          sbit led_en = P2 ^ 7; // ledä½¿èƒ½
  12          sbit led_rw = P2 ^ 6; //è¯»å†™
  13          sbit led_rs = P2 ^ 5; //æ•°æ®ã€æŒ‡ä»¤é€‰æ‹©
  14          sbit background_light = P2 ^ 4;
  15          
  16          sbit buzzer = P2 ^ 3;        //èœ‚é¸£å™¨
  17          sbit button_buzzer = P1 ^ 3; //æŒ‰é”®åé¦ˆéŸ³
  18          
  19          sbit IO = P2 ^ 1; // 1302è®¡æ—¶å™¨
  20          sbit SCLK = P2 ^ 0;
  21          sbit RST = P2 ^ 2;
  22          
  23          sbit button1 = P1 ^ 0; //æ§åˆ¶æŒ‰é”®
  24          sbit button2 = P1 ^ 1;
  25          sbit button3 = P1 ^ 2;
  26          
  27          sbit hcsr04_trig = P1 ^ 4;
  28          sbit hcsr04_echo = P1 ^ 5;
  29          
  30          uchar code tab1[] = {"    20  -  -"}; //å¹´æ˜¾ç¤ºçš„å›ºå®šå­—ç¬¦
  31          uchar code tab2[] = {"  :  :"};       //æ—¶é—´æ˜¾ç¤ºçš„å›ºå®šå­—ç¬¦
  32          uchar code weekday[7][3] = {"Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"};
  33          uchar second, minute, hour, day, week, month, year, temp, tem, clk_hour, clk_min, clk_on;
  34          uint dis, dis_pre, j;
  35          
  36          void buzzer_on(uint);
  37          
  38          void ds1302_init(void);        //
  39          void write_1302(uchar, uchar); //å‘1302å†™å…¥æ•°æ®å‡½æ•°ï¼ŒæŒ‡å®šè¯»å–æ•°æ®æ¥æºåœ°å€,å’Œå†™å…¥æ•°æ
             -®
  40          uchar read_1302(uchar);        //ä»1302è¯»æ•°æ®å‡½æ•°ï¼ŒæŒ‡å®šè¯»å–æ•°æ®æ¥æºåœ°å€
  41          
  42          void lcd_init(void);       // lcd1602a
  43          void write_lcd_com(uchar); //***æ¶²æ™¶å†™å…¥å‘½ä»¤å‡½æ•°
  44          void write_lcd_dat(uchar); //***æ¶²æ™¶å†™å…¥æ•°æ®å‡½æ•°
  45          void time_read(void);
  46          void time_first_row_write(uchar, uchar); // lcdæ—¶é—´å†™å…¥,å‚æ•°ä¸ºä½ç½®å’Œæ•°å€¼
  47          void time_second_row_write(uchar, uchar);
  48          void time_weekday_write(uchar, uchar);
  49          void lcd_time_write(void);
  50          
  51          void initT0(void); //å®šæ—¶å™¨ã€è®¡æ•°å™¨è®¾ç½®å‡½æ•°
  52          uchar BCD2Decimal(uchar);
  53          void whole_hour_tall_time(void);
C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 2   

  54          void alarm(void);
  55          
  56          void CSB(void);      //è¶…å£°æ³¢æµ‹è·
  57          void startCSB(void); //å¯åŠ¨è¶…å£°æ³¢æ¨¡å—
  58          void endTime();      //è¶…å£°æ³¢å›æ¥ï¼Œåœæ­¢è®°æ—¶
  59          void startTime();    //è¶…å£°æ³¢å‘å‡ºæ—¶åˆ»ï¼Œå¯åŠ¨è®°æ—¶
  60          uint getDistance();  //è·å–è·ç¦»çš„å‡½æ•°
  61          
  62          void main()
  63          {
  64   1          button_buzzer = 0;
  65   1          lcd_init();
  66   1          ds1302_init(); //è®¡æ—¶å™¨åˆå§‹åŒ–
  67   1          initT0();      //èœ‚é¸£å™¨å¼‚å¸¸
  68   1      
  69   1          buzzer_on(50); //ä¸Šç§»ä¼šå¯¼è‡´èƒŒå…‰è°ƒèŠ‚å¤±æ•ˆ
  70   1          clk_on = 0;
  71   1          while (1)
  72   1              ;
  73   1      }
  74          
  75          void delay10us() //å»¶æ—¶10uså‡½æ•°
  76          {
  77   1          TH1 = 0xff;
  78   1          TL1 = 0xf6;
  79   1          TR1 = 1;
  80   1          while (!TF1)
  81   1              ;
  82   1          TF1 = 0;
  83   1      }
  84          void buzzer_on(uint ms)
  85          {
  86   1          buzzer = buzzer_open;
  87   1          while ((ms--) > 0)
  88   1              delay10us();
  89   1          buzzer = buzzer_close;
  90   1      }
  91          void button_buzzer_on(uint ms)
  92          {
  93   1          button_buzzer = buzzer_open;
  94   1          while ((ms--) > 0)
  95   1              delay10us();
  96   1          button_buzzer = buzzer_close;
  97   1      }
  98          uchar BCD2Decimal(uchar bcd) // BCDç è½¬åè¿›åˆ¶å‡½æ•°ï¼Œè¾“å…¥BCDï¼Œè¿”å›åè¿›åˆ¶
  99          {
 100   1          uchar Decimal;
 101   1          Decimal = bcd >> 4;
 102   1          return (Decimal = Decimal * 10 + (bcd &= 0x0F));
 103   1      }
 104          void whole_hour_tall_time(void) //å¾…å®Œå–„
 105          {
 106   1          if (hour == 12 && minute == 0 && second == 0)
 107   1              buzzer = buzzer_open;
 108   1          if (hour == 12 && minute == 0 && second == 30)
 109   1              buzzer = buzzer_close;
 110   1      }
 111          void alarm(void)
 112          {
 113   1          if (hour == clk_hour && minute == clk_min && second == 0)
 114   1              buzzer = buzzer_open;
 115   1          if (hour == clk_hour && minute == clk_min && second == 30)
C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 3   

 116   1              buzzer = buzzer_close;
 117   1      }
 118          
 119          void lcd_init(void)
 120          {
 121   1          uint a;
 122   1          write_lcd_com(0x38);          //è®¾ç½®æ¶²æ™¶å·¥ä½œæ¨¡å¼ï¼Œæ„æ€ï¼š16*2è¡Œæ˜¾ç¤ºï¼Œ5*7ç‚¹é˜µï¼Œ8ä½æ•
             -°æ®
 123   1          write_lcd_com(0x0c);          //å¼€æ˜¾ç¤ºä¸æ˜¾ç¤ºå…‰æ ‡
 124   1          write_lcd_com(0x06);          //æ•´å±ä¸ç§»åŠ¨ï¼Œå…‰æ ‡è‡ªåŠ¨å³ç§»
 125   1          write_lcd_com(0x01);          //æ¸…æ˜¾ç¤º
 126   1          write_lcd_com(first_row + 1); //æ—¥å†æ˜¾ç¤ºå›ºå®šç¬¦å·ä»ç¬¬ä¸€è¡Œç¬¬1ä¸ªä½ç½®ä¹‹åå¼€å§‹æ˜¾ç¤º
 127   1      
 128   1          for (a = 0; a < 14; a++)
 129   1              write_lcd_dat(tab1[a]);    //å‘æ¶²æ™¶å±å†™æ—¥å†æ˜¾ç¤ºçš„å›ºå®šç¬¦å·éƒ¨åˆ†
 130   1          write_lcd_com(secode_row + 3); //æ—¶é—´æ˜¾ç¤ºå›ºå®šç¬¦å·å†™å…¥ä½ç½®ï¼Œä»ç¬¬2ä¸ªä½ç½®åå¼€å§‹æ˜¾ç¤
             -º
 131   1          for (a = 0; a < 6; a++)
 132   1              write_lcd_dat(tab2[a]); //å†™æ˜¾ç¤ºæ—¶é—´å›ºå®šç¬¦å·ï¼Œä¸¤ä¸ªå†’å·
 133   1      }
 134          void write_lcd_com(uchar com) //****æ¶²æ™¶å†™å…¥æŒ‡ä»¤å‡½æ•°****
 135          {
 136   1          led_rs = 0; //æ•°æ®/æŒ‡ä»¤é€‰æ‹©ç½®ä¸ºæŒ‡ä»¤
 137   1          led_rw = 0; //è¯»å†™é€‰æ‹©ç½®ä¸ºå†™
 138   1          P0 = com;   //é€å…¥æ•°æ®
 139   1          led_en = 1; //æ‹‰é«˜ä½¿èƒ½ç«¯ï¼Œä¸ºåˆ¶é€ æœ‰æ•ˆçš„ä¸‹é™æ²¿åšå‡†å¤‡
 140   1          for (j = 6; j > 0; j--)
 141   1              delay10us();
 142   1          led_en = 0; // led_enç”±é«˜å˜ä½ï¼Œäº§ç”Ÿä¸‹é™æ²¿ï¼Œæ¶²æ™¶æ‰§è¡Œå‘½ä»¤
 143   1          for (j = 3; j > 0; j--)
 144   1              delay10us();
 145   1      }
 146          void write_lcd_dat(uchar dat) //***æ¶²æ™¶å†™å…¥æ•°æ®å‡½æ•°****
 147          {
 148   1          uint i = 9;
 149   1          led_rs = 1; //æ•°æ®/æŒ‡ä»¤é€‰æ‹©ç½®ä¸ºæ•°æ®
 150   1          led_rw = 0; //è¯»å†™é€‰æ‹©ç½®ä¸ºå†™
 151   1          P0 = dat;   //é€å…¥æ•°æ®
 152   1          led_en = 1; // led_enç½®é«˜ç”µå¹³ï¼Œä¸ºåˆ¶é€ ä¸‹é™æ²¿åšå‡†å¤‡
 153   1          for (i; i > 0; i--)
 154   1              delay10us();
 155   1          led_en = 0; // led_enç”±é«˜å˜ä½ï¼Œäº§ç”Ÿä¸‹é™æ²¿ï¼Œæ¶²æ™¶æ‰§è¡Œå‘½ä»¤
 156   1      }
 157          
 158          void ds1302_init() // 1302èŠ¯ç‰‡åˆå§‹åŒ–å­å‡½æ•°
 159          {
 160   1          RST = 0;
 161   1          SCLK = 0;
 162   1          write_1302(0x8e, 0x00); //å…è®¸å†™ï¼Œç¦æ­¢å†™ä¿æŠ¤ 10001110
 163   1          write_1302(0xa0, 0x00); //å…è®¸å†™ï¼Œç¦æ­¢å†™ä¿æŠ¤ 10100000
 164   1          write_1302(0xa0, 0x00); //å…è®¸å†™ï¼Œç¦æ­¢å†™ä¿æŠ¤
 165   1          write_1302(0xa0, 0x00); //å…è®¸å†™ï¼Œç¦æ­¢å†™ä¿æŠ¤
 166   1          /*     write_1302(0x80, 0x30); //ç§’
 167   1              write_1302(0x82, 0x31); //åˆ†
 168   1              write_1302(0x84, 0x20); //æ—¶
 169   1              write_1302(0x86, 0x25); //æ—¥
 170   1              write_1302(0x88, 0x09); //æœˆ
 171   1              write_1302(0x8c, 0x22); //å¹´ */
 172   1          write_1302(0x8e, 0x80);
 173   1      }
 174          void write_1302(uchar add, uchar dat) //å‘1302èŠ¯ç‰‡å†™å‡½æ•°ï¼ŒæŒ‡å®šå†™å…¥åœ°å€ï¼Œæ•°æ®
 175          {
C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 4   

 176   1          uchar i;
 177   1          RST = 0;
 178   1          SCLK = 0;
 179   1          RST = 1;
 180   1          for (i = 0; i < 8; i++)
 181   1          {
 182   2              IO = add & (0x01 << i);
 183   2              SCLK = 0;
 184   2              SCLK = 1;
 185   2          }
 186   1          for (i = 0; i < 8; i++)
 187   1          {
 188   2              IO = dat & (0x01 << i);
 189   2              SCLK = 0;
 190   2              SCLK = 1;
 191   2          }
 192   1          SCLK = 0;
 193   1      }
 194          uchar read_1302(uchar add) //
 195          {
 196   1          uchar i, DATA = 0x00;
 197   1          RST = 0;
 198   1          SCLK = 0;
 199   1          RST = 1;
 200   1          for (i = 0; i < 8; i++)
 201   1          {
 202   2              IO = add & (0x01 << i);
 203   2              SCLK = 1;
 204   2              SCLK = 0;
 205   2          }
 206   1          for (i = 0; i < 8; i++)
 207   1          {
 208   2              if (IO)
 209   2                  DATA = DATA | (0x01 << i);
 210   2              SCLK = 1;
 211   2              SCLK = 0;
 212   2          }
 213   1          return DATA;
 214   1      }
 215          
 216          void initT0(void) //å®šæ—¶å™¨ã€è®¡æ•°å™¨è®¾ç½®å‡½æ•°
 217          {
 218   1          TMOD = 0x01;
 219   1          TH0 = 0xD8; // 65536-10000
 220   1          TL0 = 0xF0; // 0xD8F0=65536-10000
 221   1          EA = 1;
 222   1          ET0 = 1;
 223   1          TR0 = 1;
 224   1      }
 225          
 226          void time_read(void)
 227          {
 228   1          second = BCD2Decimal(read_1302(0x81));
 229   1          minute = BCD2Decimal(read_1302(0x83));
 230   1          hour = BCD2Decimal(read_1302(0x85));
 231   1          day = BCD2Decimal(read_1302(0x87));
 232   1          week = BCD2Decimal(read_1302(0x8b));
 233   1          month = BCD2Decimal(read_1302(0x89));
 234   1          year = BCD2Decimal(read_1302(0x8d));
 235   1      }
 236          void time_first_row_write(uchar add, uchar dat)
 237          {
C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 5   

 238   1          uchar unit, decade; //ä¸ªä½åä½
 239   1          write_lcd_com(first_row + add);
 240   1          decade = dat / 10;
 241   1          unit = dat % 10;
 242   1          write_lcd_dat('0' + decade); //'0'=0x30
 243   1          write_lcd_dat('0' + unit);
 244   1      }
 245          void time_second_row_write(uchar add, uchar dat)
 246          {
 247   1          uchar unit, decade; //ä¸ªä½åä½
 248   1          write_lcd_com(secode_row + add);
 249   1          // bai = dat/100;
 250   1          decade = dat / 10;
 251   1          unit = dat % 10;
 252   1          // write_lcd_dat('0'+bai);
 253   1          write_lcd_dat('0' + decade);
 254   1          write_lcd_dat('0' + unit);
 255   1      }
 256          void time_weekday_write(uchar add, uchar dat)
 257          {
 258   1          write_lcd_com(first_row + add);
 259   1          for (j = 0; j < 3; j++)
 260   1              write_lcd_dat(weekday[dat - 1][j]);
 261   1      }
 262          void lcd_time_write(void)
 263          {
 264   1          time_first_row_write(3, year);
 265   1          time_first_row_write(6, month);
 266   1          time_first_row_write(9, day);
 267   1          time_second_row_write(3, hour);
 268   1          time_second_row_write(6, minute);
 269   1          time_second_row_write(9, second);
 270   1          time_weekday_write(12, week);
 271   1          time_second_row_write(12, temp);
 272   1          // time_second_row_write(0, tem);
 273   1      }
 274          
 275          void CSB(void)
 276          {
 277   1      
 278   1          startCSB();
 279   1          while (hcsr04_echo != 1)
 280   1              ; //å‘å‡ºè¶…å£°æ³¢ï¼Œå¼€å§‹è®¡ç®—æ—¶é—´
 281   1          startTime();
 282   1          while (hcsr04_echo != 0)
 283   1              ; //è¶…å£°æ³¢å›æ¥ï¼Œæ—¶é—´æˆªæ­¢
 284   1          endTime();
 285   1          dis_pre = dis;
 286   1          dis = getDistance(); //è·å–è·ç¦»
 287   1      
 288   1          temp = dis;
 289   1      
 290   1          if (dis_pre - dis > 30)
 291   1          {
 292   2              background_light = 0;
 293   2              TH2 = 0x00; // 65536-10000
 294   2              TL2 = 0x00; // 55536
 295   2              EA = 1;
 296   2              ET2 = 1;
 297   2              TR2 = 1;
 298   2          }
 299   1      }
C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 6   

 300          void startCSB(void) //å¯åŠ¨è¶…å£°æ³¢æ¨¡å—
 301          {
 302   1          hcsr04_trig = 0;
 303   1          hcsr04_trig = 1;
 304   1          delay10us();
 305   1          hcsr04_trig = 0;
 306   1      }
 307          void startTime() //è¶…å£°æ³¢å‘å‡ºæ—¶åˆ»ï¼Œå¯åŠ¨è®°æ—¶
 308          {
 309   1          TH1 = 0;
 310   1          TL1 = 0;
 311   1          TR1 = 1;
 312   1      }
 313          void endTime() //è¶…å£°æ³¢å›æ¥ï¼Œåœæ­¢è®°æ—¶
 314          {
 315   1          TR1 = 0;
 316   1      }
 317          uint getDistance() //è·å–è·ç¦»çš„å‡½æ•°
 318          {
 319   1          uint distance;
 320   1          uint time;
 321   1          time = TH1 << 8 | TL1;
 322   1          distance = (time >> 7) % 100;
 323   1          return distance;
 324   1      }
 325          
 326          void timer0_lcd_change() interrupt 1
 327          {
 328   1          TH0 = 0xD8;
 329   1          TL0 = 0xF0;
 330   1          time_read();
 331   1          lcd_time_write();
 332   1      
 333   1          { //è¶…å£°æ³¢ï¼Œé—¹é’Ÿ
 334   2              if (clk_on == 1)
 335   2                  alarm();
 336   2              whole_hour_tall_time(); //æ•´ç‚¹æŠ¥æ—¶
 337   2              CSB();
 338   2          }
 339   1      
 340   1          { //æŒ‰é”®ç›‘æµ‹
 341   2              if (button1 == 0 || button2 == 0 || button3 == 0)
 342   2              {
 343   3                  _nop_();
 344   3                  if (button1 == 0)
 345   3                  {
 346   4                      button_buzzer_on(2000);
 347   4                  }
 348   3                  else if (button2 == 0)
 349   3                  {
 350   4                      button_buzzer_on(2000);
 351   4                  }
 352   3                  else if (button3 == 0)
 353   3                  {
 354   4                      button_buzzer_on(2000);
 355   4                  }
 356   3              }
 357   2          }
 358   1      }
 359          
 360          void back_ground_delay() interrupt 5
 361          {
C51 COMPILER V9.60.0.0   MAIN                                                              09/25/2022 21:53:08 PAGE 7   

 362   1          background_light = 0;
 363   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1091    ----
   CONSTANT SIZE    =     41    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     18       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
